/*
  Copyright (c) [2023-2024] [AppLayer Developers]
  This software is distributed under the MIT License.
  See the LICENSE.txt file in the project root for more information.
*/

#include "../src/libs/catch2/catch_amalgamated.hpp"
#include "../src/contract/abi.h"
#include "../src/utils/options.h"
#include "../src/core/rdpos.h"
#include "../sdktestsuite.hpp"
#include "contract/templates/erc721test.h"

namespace TERC721BENCHMARK {
  /*
   *
   * ERC721:
   *    pragma solidity ^0.8.0;
   *
   *    import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
   *    import "@openzeppelin/contracts/access/Ownable.sol";
   *    import "@openzeppelin/contracts/utils/Counters.sol";
   *
   *    contract RareNFT is ERC721, Ownable {
   *        using Counters for Counters.Counter;
   *        Counters.Counter private _tokenIds;
   *        constructor() ERC721("RareNFT", "RNFT") Ownable(msg.sender) {}
   *
   *        function mint(address to) public
   *        {
   *            uint256 newItemId = _tokenIds.current();
   *                    _safeMint(to, newItemId);
   *            _tokenIds.increment();
   *        }
   *
   *        function totalSupply() public view returns (uint256) {
   *            return _tokenIds.current();
   *        }
   *    }
   */

  const Bytes erc721bytecode = Hex::toBytes("608060405234801561000f575f80fd5b50336040518060400160405280600781526020016614985c9953919560ca1b815250604051806040016040528060048152602001631493919560e21b815250815f908161005c9190610191565b5060016100698282610191565b5050506001600160a01b03811661009957604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b6100a2816100a8565b5061024b565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b634e487b7160e01b5f52604160045260245ffd5b600181811c9082168061012157607f821691505b60208210810361013f57634e487b7160e01b5f52602260045260245ffd5b50919050565b601f82111561018c57805f5260205f20601f840160051c8101602085101561016a5750805b601f840160051c820191505b81811015610189575f8155600101610176565b50505b505050565b81516001600160401b038111156101aa576101aa6100f9565b6101be816101b8845461010d565b84610145565b6020601f8211600181146101f0575f83156101d95750848201515b5f19600385901b1c1916600184901b178455610189565b5f84815260208120601f198516915b8281101561021f57878501518255602094850194600190920191016101ff565b508482101561023c57868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b6110b1806102585f395ff3fe608060405234801561000f575f80fd5b5060043610610111575f3560e01c806370a082311161009e578063a22cb4651161006e578063a22cb46514610228578063b88d4fde1461023b578063c87b56dd1461024e578063e985e9c514610261578063f2fde38b14610274575f80fd5b806370a08231146101f4578063715018a6146102075780638da5cb5b1461020f57806395d89b4114610220575f80fd5b806318160ddd116100e457806318160ddd1461019257806323b872dd146101a857806342842e0e146101bb5780636352211e146101ce5780636a627842146101e1575f80fd5b806301ffc9a71461011557806306fdde031461013d578063081812fc14610152578063095ea7b31461017d575b5f80fd5b610128610123366004610d3c565b610287565b60405190151581526020015b60405180910390f35b6101456102d8565b6040516101349190610da4565b610165610160366004610db6565b610367565b6040516001600160a01b039091168152602001610134565b61019061018b366004610de8565b61038e565b005b61019a61039d565b604051908152602001610134565b6101906101b6366004610e10565b6103ac565b6101906101c9366004610e10565b61043a565b6101656101dc366004610db6565b610459565b6101906101ef366004610e4a565b610463565b61019a610202366004610e4a565b610487565b6101906104cc565b6006546001600160a01b0316610165565b6101456104df565b610190610236366004610e63565b6104ee565b610190610249366004610eb0565b6104f9565b61014561025c366004610db6565b610510565b61012861026f366004610f8d565b610581565b610190610282366004610e4a565b6105ae565b5f6001600160e01b031982166380ac58cd60e01b14806102b757506001600160e01b03198216635b5e139f60e01b145b806102d257506301ffc9a760e01b6001600160e01b03198316145b92915050565b60605f80546102e690610fbe565b80601f016020809104026020016040519081016040528092919081815260200182805461031290610fbe565b801561035d5780601f106103345761010080835404028352916020019161035d565b820191905f5260205f20905b81548152906001019060200180831161034057829003601f168201915b5050505050905090565b5f610371826105eb565b505f828152600460205260409020546001600160a01b03166102d2565b610399828233610623565b5050565b5f6103a760075490565b905090565b6001600160a01b0382166103da57604051633250574960e11b81525f60048201526024015b60405180910390fd5b5f6103e6838333610630565b9050836001600160a01b0316816001600160a01b031614610434576040516364283d7b60e01b81526001600160a01b03808616600483015260248201849052821660448201526064016103d1565b50505050565b61045483838360405180602001604052805f8152506104f9565b505050565b5f6102d2826105eb565b5f61046d60075490565b90506104798282610722565b610399600780546001019055565b5f6001600160a01b0382166104b1576040516322718ad960e21b81525f60048201526024016103d1565b506001600160a01b03165f9081526003602052604090205490565b6104d461073b565b6104dd5f610768565b565b6060600180546102e690610fbe565b6103993383836107b9565b6105048484846103ac565b61043484848484610857565b606061051b826105eb565b505f61053160408051602081019091525f815290565b90505f81511161054f5760405180602001604052805f81525061057a565b806105598461097d565b60405160200161056a929190610ff6565b6040516020818303038152906040525b9392505050565b6001600160a01b039182165f90815260056020908152604080832093909416825291909152205460ff1690565b6105b661073b565b6001600160a01b0381166105df57604051631e4fbdf760e01b81525f60048201526024016103d1565b6105e881610768565b50565b5f818152600260205260408120546001600160a01b0316806102d257604051637e27328960e01b8152600481018490526024016103d1565b6104548383836001610a0d565b5f828152600260205260408120546001600160a01b039081169083161561065c5761065c818486610b11565b6001600160a01b03811615610696576106775f855f80610a0d565b6001600160a01b0381165f90815260036020526040902080545f190190555b6001600160a01b038516156106c4576001600160a01b0385165f908152600360205260409020805460010190555b5f8481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b610399828260405180602001604052805f815250610b75565b6006546001600160a01b031633146104dd5760405163118cdaa760e01b81523360048201526024016103d1565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0382166107eb57604051630b61174360e31b81526001600160a01b03831660048201526024016103d1565b6001600160a01b038381165f81815260056020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6001600160a01b0383163b1561043457604051630a85bd0160e11b81526001600160a01b0384169063150b7a0290610899903390889087908790600401611024565b6020604051808303815f875af19250505080156108d3575060408051601f3d908101601f191682019092526108d091810190611060565b60015b61093a573d808015610900576040519150601f19603f3d011682016040523d82523d5f602084013e610905565b606091505b5080515f0361093257604051633250574960e11b81526001600160a01b03851660048201526024016103d1565b805181602001fd5b6001600160e01b03198116630a85bd0160e11b1461097657604051633250574960e11b81526001600160a01b03851660048201526024016103d1565b5050505050565b60605f61098983610b8b565b60010190505f8167ffffffffffffffff8111156109a8576109a8610e9c565b6040519080825280601f01601f1916602001820160405280156109d2576020820181803683370190505b5090508181016020015b5f19016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a85049450846109dc57509392505050565b8080610a2157506001600160a01b03821615155b15610ae2575f610a30846105eb565b90506001600160a01b03831615801590610a5c5750826001600160a01b0316816001600160a01b031614155b8015610a6f5750610a6d8184610581565b155b15610a985760405163a9fbf51f60e01b81526001600160a01b03841660048201526024016103d1565b8115610ae05783856001600160a01b0316826001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45b505b50505f90815260046020526040902080546001600160a01b0319166001600160a01b0392909216919091179055565b610b1c838383610c62565b610454576001600160a01b038316610b4a57604051637e27328960e01b8152600481018290526024016103d1565b60405163177e802f60e01b81526001600160a01b0383166004820152602481018290526044016103d1565b610b7f8383610cc6565b6104545f848484610857565b5f8072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b8310610bc95772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310610bf5576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc100008310610c1357662386f26fc10000830492506010015b6305f5e1008310610c2b576305f5e100830492506008015b6127108310610c3f57612710830492506004015b60648310610c51576064830492506002015b600a83106102d25760010192915050565b5f6001600160a01b03831615801590610cbe5750826001600160a01b0316846001600160a01b03161480610c9b5750610c9b8484610581565b80610cbe57505f828152600460205260409020546001600160a01b038481169116145b949350505050565b6001600160a01b038216610cef57604051633250574960e11b81525f60048201526024016103d1565b5f610cfb83835f610630565b90506001600160a01b03811615610454576040516339e3563760e11b81525f60048201526024016103d1565b6001600160e01b0319811681146105e8575f80fd5b5f60208284031215610d4c575f80fd5b813561057a81610d27565b5f5b83811015610d71578181015183820152602001610d59565b50505f910152565b5f8151808452610d90816020860160208601610d57565b601f01601f19169290920160200192915050565b602081525f61057a6020830184610d79565b5f60208284031215610dc6575f80fd5b5035919050565b80356001600160a01b0381168114610de3575f80fd5b919050565b5f8060408385031215610df9575f80fd5b610e0283610dcd565b946020939093013593505050565b5f805f60608486031215610e22575f80fd5b610e2b84610dcd565b9250610e3960208501610dcd565b929592945050506040919091013590565b5f60208284031215610e5a575f80fd5b61057a82610dcd565b5f8060408385031215610e74575f80fd5b610e7d83610dcd565b915060208301358015158114610e91575f80fd5b809150509250929050565b634e487b7160e01b5f52604160045260245ffd5b5f805f8060808587031215610ec3575f80fd5b610ecc85610dcd565b9350610eda60208601610dcd565b925060408501359150606085013567ffffffffffffffff811115610efc575f80fd5b8501601f81018713610f0c575f80fd5b803567ffffffffffffffff811115610f2657610f26610e9c565b604051601f8201601f19908116603f0116810167ffffffffffffffff81118282101715610f5557610f55610e9c565b604052818152828201602001891015610f6c575f80fd5b816020840160208301375f6020838301015280935050505092959194509250565b5f8060408385031215610f9e575f80fd5b610fa783610dcd565b9150610fb560208401610dcd565b90509250929050565b600181811c90821680610fd257607f821691505b602082108103610ff057634e487b7160e01b5f52602260045260245ffd5b50919050565b5f8351611007818460208801610d57565b83519083019061101b818360208801610d57565b01949350505050565b6001600160a01b03858116825284166020820152604081018390526080606082018190525f9061105690830184610d79565b9695505050505050565b5f60208284031215611070575f80fd5b815161057a81610d2756fea2646970667358221220f6578f6f95cd7ee215d7f237c17285b6ab9e6513944d48af0f86248ef45ec9cf64736f6c634300081a0033");

  TEST_CASE("ERC721 Benchmark", "[benchmark]") {
    SECTION("CPP ERC721 Benchmark") {
      std::unique_ptr<Options> options = nullptr;
      Address to(Utils::randBytes(20));

      SDKTestSuite sdk = SDKTestSuite::createNewEnvironment("testERC721CPPBenchmark");
      auto erc721Address = sdk.deployContract<ERC721Test>(std::string("MintNFT"), std::string("MNFT"), std::numeric_limits<uint64_t>::max());
      // Now for the funny part, we are NOT a C++ contract, but we can
      // definitely take advantage of the templated ABI to interact with it
      // as the encoding is the same

      // Create the transaction for transfer
      auto functor = Utils::uint32ToBytes(ABI::FunctorEncoder::encode<Address>("mint").value);
      Bytes mintEncoded(functor.cbegin(), functor.cend());
      Utils::appendBytes(mintEncoded, ABI::Encoder::encodeData<Address>(to));
      TxBlock transferTx = sdk.createNewTx(sdk.getChainOwnerAccount(), erc721Address, 0, mintEncoded);
      auto& state = sdk.getState();
      evmc_tx_context txContext;

      txContext.tx_origin = sdk.getChainOwnerAccount().address.toEvmcAddress();
      txContext.tx_gas_price = {};
      txContext.block_coinbase = to.toEvmcAddress();
      txContext.block_number = 1;
      txContext.block_timestamp = 1;
      txContext.block_gas_limit = std::numeric_limits<int64_t>::max();
      txContext.block_prev_randao = {};
      txContext.chain_id = {};
      txContext.block_base_fee = {};
      txContext.blob_base_fee = {};
      txContext.blob_hashes = nullptr;
      txContext.blob_hashes_count = 0;

      auto callInfo = transferTx.txToMessage();
      Hash randomnessHash = bytes::random();
      int64_t leftOverGas = std::numeric_limits<int64_t>::max();
      uint64_t iterations = 1000000;

      auto start = std::chrono::high_resolution_clock::now();
      for (uint64_t i = 0; i < iterations; i++) {
        state.call(callInfo, txContext, ContractType::CPP, randomnessHash, randomnessHash, randomnessHash, leftOverGas);
      }
      auto end = std::chrono::high_resolution_clock::now();

      long double durationInMicroseconds = std::chrono::duration_cast<std::chrono::microseconds>(end - start).count();
      long double microSecsPerCall = durationInMicroseconds / iterations;
      std::cout << "CPP ERC721 Mint took " << microSecsPerCall << " microseconds per call" << std::endl;
      std::cout << "CPP Total Time: " << durationInMicroseconds / 1000000 << " seconds" << std::endl;
      // Check totalSupply
      REQUIRE(sdk.callViewFunction(erc721Address, &ERC721Test::totalSupply) == iterations);
      // Dump the state
      sdk.getState().saveToDB();
    }
    SECTION("EVM ERC721 Benchmark") {
      std::unique_ptr<Options> options = nullptr;
      Address to(Utils::randBytes(20));

      SDKTestSuite sdk = SDKTestSuite::createNewEnvironment("testERC721EVMBenchmark");
      auto erc721Address = sdk.deployBytecode(erc721bytecode);
      // Now for the funny part, we are NOT a C++ contract, but we can
      // definitely take advantage of the templated ABI to interact with it
      // as the encoding is the same

      // Create the transaction for transfer
      auto functor = Utils::uint32ToBytes(ABI::FunctorEncoder::encode<Address>("mint").value);
      Bytes mintEncoded(functor.cbegin(), functor.cend());
      Utils::appendBytes(mintEncoded, ABI::Encoder::encodeData<Address>(to));
      TxBlock transferTx = sdk.createNewTx(sdk.getChainOwnerAccount(), erc721Address, 0, mintEncoded);
      auto& state = sdk.getState();
      evmc_tx_context txContext;

      txContext.tx_origin = sdk.getChainOwnerAccount().address.toEvmcAddress();
      txContext.tx_gas_price = {};
      txContext.block_coinbase = to.toEvmcAddress();
      txContext.block_number = 1;
      txContext.block_timestamp = 1;
      txContext.block_gas_limit = std::numeric_limits<int64_t>::max();
      txContext.block_prev_randao = {};
      txContext.chain_id = {};
      txContext.block_base_fee = {};
      txContext.blob_base_fee = {};
      txContext.blob_hashes = nullptr;
      txContext.blob_hashes_count = 0;

      auto callInfo = transferTx.txToMessage();
      Hash randomnessHash = bytes::random();
      int64_t leftOverGas = std::numeric_limits<int64_t>::max();
      uint64_t iterations = 100000;

      auto start = std::chrono::high_resolution_clock::now();
      for (uint64_t i = 0; i < iterations; i++) {
        state.call(callInfo, txContext, ContractType::EVM, randomnessHash, randomnessHash, randomnessHash, leftOverGas);
      }
      auto end = std::chrono::high_resolution_clock::now();

      long double durationInMicroseconds = std::chrono::duration_cast<std::chrono::microseconds>(end - start).count();
      long double microSecsPerCall = durationInMicroseconds / iterations;
      std::cout << "EVM ERC721 Mint took " << microSecsPerCall << " microseconds per call" << std::endl;
      std::cout << "EVM Total Time: " << durationInMicroseconds / 1000000 << " seconds" << std::endl;
      // Check totalSupply
      REQUIRE(sdk.callViewFunction(erc721Address, &ERC721Test::totalSupply) == iterations);
      // Dump the state
      sdk.getState().saveToDB();
    }
  }
}
